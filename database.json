require("dotenv").config();
const fs = require("fs");
const {
  Client, GatewayIntentBits, REST, Routes, SlashCommandBuilder, ModalBuilder,
  TextInputBuilder, TextInputStyle, ActionRowBuilder, EmbedBuilder, ButtonBuilder, ButtonStyle, ChannelType, PermissionFlagsBits
} = require("discord.js");

const client = new Client({ 
  intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildMessages, GatewayIntentBits.MessageContent] 
});

// IDs CONFIGURADOS
const IDS = {
  CHANNELS: {
    RANKING: "1473874178766671993",
    APOSTADO: "1473873854232264886",
    X1: "1473873994674606231",
    SIMU: "1465842384586670254"
  },
  ROLES: {
    STAFF: "1452822476949029001",
    DONO: "1452822605773148312",
    ORGANIZADOR: "1453126709447754010"
  }
};

// COMANDOS
const commands = [
  new SlashCommandBuilder().setName("parceria").setDescription("Criar parceria com modal"),
  new SlashCommandBuilder().setName("xcla").setDescription("Registrar resultado de X-Cl√£"),
  new SlashCommandBuilder()
    .setName("x1")
    .setDescription("Criar um desafio X1")
    .addStringOption(opt => opt.setName("mapa").setDescription("Qual o mapa?").setRequired(true))
    .addUserOption(opt => opt.setName("oponente").setDescription("Marcar um oponente espec√≠fico")),
  new SlashCommandBuilder()
    .setName("apostado")
    .setDescription("Criar um desafio Apostado")
    .addStringOption(opt => opt.setName("mapa").setDescription("Qual o mapa?").setRequired(true))
    .addStringOption(opt => opt.setName("valor").setDescription("Valor da aposta (R$)").setRequired(true))
    .addUserOption(opt => opt.setName("oponente").setDescription("Marcar um oponente espec√≠fico")),
  new SlashCommandBuilder().setName("ranking").setDescription("Ver o ranking de Simu")
].map(cmd => cmd.toJSON());

const rest = new REST({ version: "10" }).setToken(process.env.TOKEN);

(async () => {
  try {
    await rest.put(Routes.applicationGuildCommands(process.env.CLIENT_ID, process.env.GUILD_ID), { body: commands });
    console.log("Comandos registrados!");
  } catch (error) { console.error(error); }
})();

// FUN√á√ÉO RANKING
function updateRank(userId, win) {
  let data = JSON.parse(fs.readFileSync("./database.json", "utf8"));
  if (!data[userId]) data[userId] = { v: 0, d: 0 };
  if (win) data[userId].v += 1; else data[userId].d += 1;
  fs.writeFileSync("./database.json", JSON.stringify(data, null, 2));
}

client.on("interactionCreate", async (interaction) => {
  
  // LOGICA X1 E APOSTADO
  if (interaction.isChatInputCommand() && (interaction.commandName === "x1" || interaction.commandName === "apostado")) {
    const isApostado = interaction.commandName === "apostado";
    const canalAlvo = isApostado ? IDS.CHANNELS.APOSTADO : IDS.CHANNELS.X1;

    if (interaction.channelId !== canalAlvo) {
      return interaction.reply({ content: `Use este comando em <#${canalAlvo}>`, ephemeral: true });
    }

    const mapa = interaction.options.getString("mapa");
    const oponente = interaction.options.getUser("oponente");
    const valor = isApostado ? interaction.options.getString("valor") : null;

    const embed = new EmbedBuilder()
      .setTitle(isApostado ? "üí∞ NOVO APOSTADO" : "‚öîÔ∏è NOVO X1")
      .setColor(isApostado ? "Gold" : "LuminousVividPink")
      .addFields(
        { name: "Mapa", value: mapa, inline: true },
        { name: "Desafiante", value: interaction.user.toString(), inline: true }
      );
    if (valor) embed.addFields({ name: "Valor", value: `R$ ${valor}`, inline: true });

    const btn = new ButtonBuilder()
      .setCustomId(oponente ? `aceitar_${oponente.id}_${interaction.user.id}_${valor || "0"}` : `entrar_aberto_${interaction.user.id}_${valor || "0"}`)
      .setLabel(oponente ? `Aceitar Desafio de ${interaction.user.username}` : "Entrar no Desafio")
      .setStyle(ButtonStyle.Success);

    await interaction.reply({ embeds: [embed], components: [new ActionRowBuilder().addComponents(btn)] });
  }

  // ACEITAR DESAFIO E CRIAR CANAL
  if (interaction.isButton() && (interaction.customId.startsWith("aceitar_") || interaction.customId.startsWith("entrar_aberto_"))) {
    const parts = interaction.customId.split("_");
    const creatorId = parts[2];
    const valor = parts[3];

    if (parts[0] === "aceitar" && interaction.user.id !== parts[1]) {
      return interaction.reply({ content: "Este desafio n√£o √© para voc√™!", ephemeral: true });
    }

    const channel = await interaction.guild.channels.create({
      name: `ü•ä-${interaction.user.username}-vs-creator`,
      type: ChannelType.GuildText,
      permissionOverwrites: [
        { id: interaction.guild.id, deny: [PermissionFlagsBits.ViewChannel] },
        { id: creatorId, allow: [PermissionFlagsBits.ViewChannel, PermissionFlagsBits.SendMessages] },
        { id: interaction.user.id, allow: [PermissionFlagsBits.ViewChannel, PermissionFlagsBits.SendMessages] },
        { id: IDS.ROLES.STAFF, allow: [PermissionFlagsBits.ViewChannel, PermissionFlagsBits.SendMessages] },
        { id: IDS.ROLES.DONO, allow: [PermissionFlagsBits.ViewChannel, PermissionFlagsBits.SendMessages] },
      ],
    });

    const row = new ActionRowBuilder().addComponents(
      new ButtonBuilder().setCustomId(`win_${creatorId}_${valor}`).setLabel(`Vencedor: AD1`).setStyle(ButtonStyle.Primary),
      new ButtonBuilder().setCustomId(`win_${interaction.user.id}_${valor}`).setLabel(`Vencedor: AD2`).setStyle(ButtonStyle.Primary)
    );

    await channel.send({ content: `Partida Iniciada!\nAD1: <@${creatorId}>\nAD2: ${interaction.user}\n\n**Apenas STAFF pode declarar o vencedor.**`, components: [row] });
    await interaction.update({ content: "Desafio aceito! Canal criado.", embeds: [], components: [] });
  }

  // DECLARAR VENCEDOR
  if (interaction.isButton() && interaction.customId.startsWith("win_")) {
    if (!interaction.member.roles.cache.has(IDS.ROLES.STAFF) && !interaction.member.roles.cache.has(IDS.ROLES.DONO)) {
      return interaction.reply({ content: "Apenas Staff ou Dono!", ephemeral: true });
    }

    const [_, winnerId, valor] = interaction.customId.split("_");
    const isApostado = valor !== "0";

    const finalEmbed = new EmbedBuilder()
      .setTitle("üèÜ FIM DE PARTIDA")
      .setDescription(`O vencedor foi <@${winnerId}>!`)
      .setColor("Green");
    if (isApostado) finalEmbed.addFields({ name: "Pr√™mio", value: `R$ ${valor}` });

    const targetChannel = isApostado ? IDS.CHANNELS.APOSTADO : IDS.CHANNELS.X1;
    await client.channels.cache.get(targetChannel).send({ embeds: [finalEmbed] });
    
    updateRank(winnerId, true);
    
    await interaction.reply("Resultado registrado! Fechando canal em 5s...");
    setTimeout(() => interaction.channel.delete(), 5000);
  }

  // COMANDO RANKING
  if (interaction.isChatInputCommand() && interaction.commandName === "ranking") {
    let data = JSON.parse(fs.readFileSync("./database.json", "utf8"));
    let sorted = Object.entries(data)
      .sort((a, b) => b[1].v - a[1].v || b[1].d - a[1].d)
      .slice(0, 10);

    let desc = sorted.map((user, i) => `${i+1}¬∫ <@${user[0]}> - üèÜ ${user[1].v} | üíÄ ${user[1].d}`).join("\n");
    
    const rankEmbed = new EmbedBuilder().setTitle("üìä Ranking Global").setDescription(desc || "Nenhum registro.").setColor("Gold");
    await interaction.reply({ embeds: [rankEmbed] });
  }

  // MANT√âM SEUS MODAIS ANTERIORES (PARCERIA/XCLA) ABAIXO...
  if (interaction.isChatInputCommand() && interaction.commandName === "parceria") { /* SEU C√ìDIGO */ }
  if (interaction.isChatInputCommand() && interaction.commandName === "xcla") { /* SEU C√ìDIGO */ }
  if (interaction.isModalSubmit()) { /* SEUS PROCESSAMENTOS DE MODAL */ }
});

client.login(process.env.TOKEN);
